<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AR Celestial Map</title>
  <!-- Include A-Frame and AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <!-- Include D3 and Celestial Libraries -->
  <script type="text/javascript" src="../lib/d3.min.js"></script>
  <script type="text/javascript" src="../lib/d3.geo.projection.min.js"></script>
  <script type="text/javascript" src="../celestial.js"></script>
  <link rel="stylesheet" href="../celestial.css">
  <style>
    .btn { display: inline-block; font: bold 14pt "Lucia Console", Consolas, monospace; margin: 0 6px; padding: 2px 6px; border: 2px solid #000; border-radius: 3px; background: rgba(204, 204, 255, 0.6); cursor: pointer; }
  </style>
</head>
<body>
  <!-- AR.js Scene -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <!-- Celestial Map as a 3D Sphere -->
    <a-entity id="celestial-sphere" geometry="primitive: sphere; radius: 5" material="shader: flat; src: #celestial-texture"></a-entity>
    <!-- AR.js Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Celestial Map Configuration -->
  <script type="text/javascript">
    var config = {
      projection: "orthographic",
      background: { fill: "#000000", stroke: "#000000", opacity: 1, width: 4 },
      datapath: "https://ofrohn.github.io/data/",
      stars: { show: false },
      dsos: { show: false },
      mw: { style: { fill: "#ffffff", opacity: "0.05" } },
      constellations: { names: false, lines: false },
      lines: {
        graticule: { show: true, stroke: "#9999cc", width: 1.0, opacity: 0.3 },
        equatorial: { show: true, stroke: "#aaaaaa", width: 1.5, opacity: 0.4 },
        ecliptic: { show: true, stroke: "#66cc66", width: 1.5, opacity: 0.4 }
      }
    };

    var planets = { sol: "#ff0", lun: "#fff", mer: "#e2e2e2", ven: "#f5f5f0", mar: "#efd1af", jup: "#e6e1df", sat: "#eddebc" };
    var limitMagnitude = 6,
        radius = 1.2,
        grayscale = false,
        starColor = d3.scale.linear()
          .domain([-1.5, 0, limitMagnitude + 1])
          .range(['white', 'white', 'black']),
        dt = new Date();

    // Create a canvas for the celestial map
    var canvas = document.createElement("canvas");
    canvas.width = 1024;
    canvas.height = 512;
    var context = canvas.getContext("2d");

    // Render the celestial map to the canvas
    Celestial.add({
      type: "json",
      file: "https://ofrohn.github.io/data/stars." + limitMagnitude + ".json",
      callback: function (error, json) {
        if (error) return console.warn(error);
        var stars = Celestial.getData(json, config.transform);
        Celestial.container.selectAll(".astars")
          .data(stars.features)
          .enter().append("path")
          .attr("class", "astar");
        Celestial.redraw();
      },
      redraw: function () {
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.globalAlpha = 1;
        var indexColor = "#fff", planet;
        Celestial.container.selectAll(".astar").each(function (d) {
          if (Celestial.clip(d.geometry.coordinates)) {
            var pt = Celestial.mapProjection(d.geometry.coordinates);
            if (grayscale === false) indexColor = Celestial.starColor(d);
            starColor.range([indexColor, indexColor, 'black']);
            context.fillStyle = starColor(d.properties.mag);
            context.beginPath();
            context.arc(pt[0], pt[1], radius, 0, 2 * Math.PI);
            context.closePath();
            context.fill();
          }
        });
        if (!Celestial.origin) return;
        var o = Celestial.origin(dt).spherical();
        for (var key in planets) {
          var planet = Celestial.getPlanet(key, dt);
          if (!Celestial.clip(planet.ephemeris.pos)) continue;
          var pt = Celestial.mapProjection(planet.ephemeris.pos);
          if (key === "lun") {
            Celestial.symbol().type("crescent").size(110).age(planet.ephemeris.age).position(pt)(context);
          } else {
            if (key === "sol") radius = 2;
            else radius = 1.2 - (planet.ephemeris.mag + 5) / 10;
            context.fillStyle = (grayscale === false) ? planets[key] : "#eee";
            context.beginPath();
            context.arc(pt[0], pt[1], radius * 2, 0, 2 * Math.PI);
            context.closePath();
            context.fill();
          }
        }
        // Update the texture of the 3D sphere
        var texture = new THREE.CanvasTexture(canvas);
        document.querySelector("#celestial-sphere").setAttribute("material", "src", texture);
      }
    });

    // Toggle grayscale
    d3.select("#btnColor").on("click", function (d) {
      grayscale = !grayscale;
      this.innerHTML = grayscale === true ? "Show Colors" : "Show Grayscale";
      Celestial.redraw();
    });

    // Initialize the celestial map
    Celestial.display(config);
    Celestial.date(dt);
  </script>
</body>
</html>