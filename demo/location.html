<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AR Celestial Starmap (360° View)</title>
  
  <!-- D3 Celestial Libraries -->
  <script type="text/javascript" src="../lib/d3.min.js"></script>
  <script type="text/javascript" src="../lib/d3.geo.projection.min.js"></script>
  <script type="text/javascript" src="../celestial.min.js"></script>
  <link rel="stylesheet" href="../celestial.css">

  <!-- A-Frame and AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>

  <!-- AR Scene with 360° Sky -->
  <a-scene embedded arjs>
    <!-- 360-degree Celestial Map -->
    <a-sky id="ar-celestial-map"></a-sky>

    <!-- Light for Visibility -->
    <a-light type="directional" position="1 1 1"></a-light>

    <!-- AR Camera with Rotation Control -->
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <!-- Hidden Celestial Map (Used for Canvas Rendering) -->
  <div id="celestial-container" style="position: absolute; top: -9999px;">
    <div id="celestial-map"></div>
  </div>

  <script type="text/javascript">
    // Generate Celestial Map
    Celestial.display({
      location: true,
      projection: "aitoff",  // A full 360-degree projection
      datapath: "../data/",
      planets: { show: true },
      container: "celestial-map"
    });

    // Apply Celestial Map to Sky After Rendering
    setTimeout(() => {
      let celestialCanvas = document.querySelector("#celestial-map canvas");

      if (celestialCanvas) {
        console.log("Celestial map canvas found. Converting to texture...");

        let textureUrl = celestialCanvas.toDataURL("image/png");
        let arSky = document.querySelector("#ar-celestial-map");

        arSky.setAttribute("material", "src", textureUrl);
      } else {
        console.error("Celestial canvas NOT found! Star map might not be rendering.");
      }
    }, 3000);
  </script>

</body>
</html>
